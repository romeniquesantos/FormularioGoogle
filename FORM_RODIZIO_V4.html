<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Contato - Rodízio (Tabela Transposta)</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

</head>

<body>
    <div class="jumbotron ">
        <div class="container">
            <h1 class="display-4">Formulário Convênio</h1>
            Esta formulário é para ser enviada por convênio, ou seja, se a filial tiver 5 convênios diferentes, deverão
            ser 5 formulário diferentes</br>
            Por favor, não alterar a lista. Caso identifique um convênio ou uma filial não existente no formulario,
            enviar email para carvas_debora@hotmail.com</br>
        </div>
    </div>

    <div class="container-fluid">
        <form id="formularioRodizio">
            <div class="form-row ml-2">
                <div class="row">
                    <div class="form-group col-3">
                        <!--<label for="FILIAL">Filial:</label>-->
                        <select class="form-control form-control-sm" id="FILIAL" name="FILIAL" required>
                            <option value="">Selecione a Filial</option>
                            <option value="UNIGRANRIO BARRA">UNIGRANRIO BARRA</option>
                        </select>
                    </div>

                    <div class="form-group col-3 ">
                        <!--<label for="CNPJ">CNPJ:</label>-->
                        <select class="form-control form-control-sm" id="CNPJ" name="CNPJ" required>
                            <option value="">Selecione o CNPJ</option>
                            <option value="HOSPITAL DA PROVIDÊNCIA">HOSPITAL DA PROVIDÊNCIA</option>
                        </select>
                    </div>

                    <div class="form-group col-3">
                        <!--<label for="CONVENIO">Convênio:</label>-->
                        <select class="form-control form-control-sm" id="CONVENIO" name="CONVENIO" required>
                            <option value="">Selecione o Convênio</option>
                            <option value="HOSPITAL DA PROVIDÊNCIA">HOSPITAL DA PROVIDÊNCIA</option>
                        </select>
                    </div>

                    <div class="form-group col-3">
                        <!--<label for="RODIZIO">Rodízio:</label>-->
                        <select class="form-control form-control-sm" id="RODIZIO" name="RODIZIO" required>
                            <option value="">Selecione o Rodízio</option>
                            <option value="TIPO_1">TIPO_1</option>
                            <option value="TIPO_2">TIPO_2</option>
                        </select>
                    </div>
                </div>

            </div>
            <div id="alertContainer" class=""></div>
            <button class="btn btn-primary btn-sm ml-2" type="button" id="adicionarTabela_"
                onclick="adicionarTabela()">Adicionar à
                Tabela</button>
            <button class="btn btn-info btn-sm ml-2" type="button" id="adicionarTabela_"
                onclick="limpar()">Limpar</button>
        </form>
    </div>
    <hr class="ml-3 mr-3">
    <div class="container-fluid mt-3">
        <table style="visibility: hidden;" id="tabelaRegistros"
            class="table table-bordered table-hover table-sm row ml-2">
            <thead class="col-2.5">
                <tr>
                </tr>
            </thead>
            <tbody class="col-2.5">
                <tr class="">
                    <th>Filial</th>
                </tr>
                <tr class="">
                    <th>CNPJ</th>
                </tr>
                <tr class="">
                    <th>Convênio</th>
                </tr>
                <tr class="">
                    <th>Rodízio</th>
                </tr>
                <tr class="">
                    <th>Subdivisão do Rodízio</th>
                </tr>
                <tr class="">
                    <th>Descrição da Subdivisão</th>
                </tr>
                <tr class="">
                    <th>Tipo de Cobrança</th>
                </tr>
                <tr class="table-info">
                    <th>Quantidade alunos mês 1</th>
                </tr>
                <tr class="table-info">
                    <th>Horas Utilizadas mês 1</th>
                </tr>
                <tr class="table-info">
                    <th>Relação Aluno/Preceptor (Grupo) mês 1</th>
                </tr>
                <tr class="">
                    <th>Quantidade alunos mês 2</th>
                </tr>
                <tr class="">
                    <th>Horas Utilizadas mês 2</th>
                </tr>
                <tr class="">
                    <th>Relação Aluno/Preceptor (Grupo) mês 2</th>
                </tr>
                <tr class="table-info">
                    <th>Quantidade alunos mês 3</th>
                </tr>
                <tr class="table-info">
                    <th>Horas Utilizadas mês 3</th>
                </tr>
                <tr class="table-info">
                    <th>Relação Aluno/Preceptor (Grupo) mês 3</th>
                </tr>
                <tr class="">
                    <th>Quantidade alunos mês 4</th>
                </tr>
                <tr class="">
                    <th>Horas Utilizadas mês 4</th>
                </tr>
                <tr class="">
                    <th>Relação Aluno/Preceptor (Grupo) mês 4</th>
                </tr>
                <tr class="table-info">
                    <th>Quantidade alunos mês 5</th>
                </tr>
                <tr class="table-info">
                    <th>Horas Utilizadas mês 5</th>
                </tr>
                <tr class="table-info">
                    <th>Relação Aluno/Preceptor (Grupo) mês 5</th>
                </tr>
                <tr class="">
                    <th>Quantidade alunos mês 6</th>
                </tr>
                <tr class="">
                    <th>Horas Utilizadas mês 6</th>
                </tr>
                <tr class="">
                    <th>Relação Aluno/Preceptor (Grupo) mês 6</th>
                </tr>
            </tbody>
        </table>

    </div>

    <div class="container-fluid ml-2 mb-5">
        <button style="visibility: hidden;" class="btn btn-primary btn-sm" id="enviarDadosPlanilha"
            onclick="enviarParaPlanilha()" disabled>Enviar
            Dados</button>
    </div>

    <script>
        window.onload = function () {
            window.scrollTo(0, 0);
        };

        let registros = [];
        let formFieldsFixed = false;
        let contadorRodizio = 0;

        function limpar() {
            const currentUrl = window.location.href;
            // Redireciona para a mesma URL
            window.location.href = currentUrl;
        }

        function showAlert(message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = ` <div class="alert alert-warning alert-dismissible fade show" role="alert"> <strong>Aviso!</strong> ${message} <button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> `;
        }

        function adicionarTabela() {
            const FILIAL = document.getElementById("FILIAL").value;
            const CNPJ = document.getElementById("CNPJ").value;
            const CONVENIO = document.getElementById("CONVENIO").value;
            const RODIZIO = document.getElementById("RODIZIO").value;


            if (FILIAL == "" || CNPJ == "" || CONVENIO == "" || RODIZIO == "") {

                if (FILIAL == "") {
                    alert("Selecione a Filial"); return;
                }
                if (CNPJ == "") {
                    alert("Selecione o CNPJ"); return;
                }
                if (CONVENIO == "") {
                    alert("Selecione o Convênio"); return;
                }
                if (RODIZIO == ""){
                    alert("Selecione o Rodízio"); return;
                }

            } else {

                document.getElementById("tabelaRegistros").style.visibility = "visible";
                document.getElementById("enviarDadosPlanilha").style.visibility = "visible";

                const rodiziosTipo1 = ["Sub_1", "Sub_2", "Sub_3", "Sub_4"];
                let subRodizio = RODIZIO === "TIPO_1" ? rodiziosTipo1[contadorRodizio] : "Sub_1";

                if (RODIZIO == "TIPO_2") {
                    document.getElementById("adicionarTabela_").disabled = true;
                }

                if (contadorRodizio >= 4) {
                    alert("Você só pode adicionar até 4 sub-rodízios.");
                    return;
                }

                // Adiciona o registro atual à lista de registros
                registros.push({ FILIAL, CNPJ, CONVENIO, RODIZIO, SUBDIVISAO_RODIZIO: subRodizio });

                // Atualiza a tabela com os novos dados
                atualizarTabela();

                contadorRodizio++;

                if (!formFieldsFixed) {
                    document.getElementById("FILIAL").disabled = true;
                    document.getElementById("CNPJ").disabled = true;
                    document.getElementById("CONVENIO").disabled = true;
                    document.getElementById("RODIZIO").disabled = true;
                    formFieldsFixed = true;
                }

                if (registros.length > 0) {
                    document.getElementById("enviarDadosPlanilha").disabled = false;
                }
            }
        }

        function atualizarTabela() {
            const tabela = document.getElementById("tabelaRegistros");
            const headerRow = tabela.getElementsByTagName("thead")[0].getElementsByTagName("tr")[0];

            // A linha de cabeçalho não deve ter mais do que uma célula para o "Campo"
            // Remover as células extra que foram criadas anteriormente
            const headerCells = headerRow.getElementsByTagName("th");
            for (let i = headerCells.length - 1; i > 1; i--) {
                headerRow.deleteCell(i);
            }

            const campos = [
                "FILIAL", "CNPJ", "CONVENIO", "RODIZIO",
                "SUBDIVISAO_RODIZIO", "DESCRICAO_SUBDIVISAO",
                "TIPO_COBRANCA",
                "QTD_ALUNOS_MES_1", "HORAS_UTILIZADAS_MES_1", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_1",
                "QTD_ALUNOS_MES_2", "HORAS_UTILIZADAS_MES_2", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_2",
                "QTD_ALUNOS_MES_3", "HORAS_UTILIZADAS_MES_3", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_3",
                "QTD_ALUNOS_MES_4", "HORAS_UTILIZADAS_MES_4", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_4",
                "QTD_ALUNOS_MES_5", "HORAS_UTILIZADAS_MES_5", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_5",
                "QTD_ALUNOS_MES_6", "HORAS_UTILIZADAS_MES_6", "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_6"
            ];

            const tbody = tabela.getElementsByTagName("tbody")[0];

            campos.forEach((campo, index) => {
                const row = tbody.getElementsByTagName("tr")[index];
                const cell = row.insertCell();

                if (campo === "DESCRICAO_SUBDIVISAO") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="text" id="DESCRICAO_SUBDIVISAO_${registros.length - 1}" name="DESCRICAO_SUBDIVISAO_${registros.length - 1}" required>`;
                } else if (campo === "TIPO_COBRANCA") {
                    cell.innerHTML = `
                        <select class="form-control form-control-sm" id="TIPO_COBRANCA_${registros.length - 1}" name="TIPO_COBRANCA_${registros.length - 1}" required>
                            <option value="">Selecione</option>
                            <option value="POR HORA">POR HORA</option>
                            <option value="POR ALUNO">POR ALUNO</option>
                            <option value="FIXO">FIXO</option>
                        </select>
                    `;
                }
                else if (campo === "QTD_ALUNOS_MES_1" || campo === "HORAS_UTILIZADAS_MES_1" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_1") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else if (campo === "QTD_ALUNOS_MES_2" || campo === "HORAS_UTILIZADAS_MES_2" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_2") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else if (campo === "QTD_ALUNOS_MES_3" || campo === "HORAS_UTILIZADAS_MES_3" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_3") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else if (campo === "QTD_ALUNOS_MES_4" || campo === "HORAS_UTILIZADAS_MES_4" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_4") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else if (campo === "QTD_ALUNOS_MES_5" || campo === "HORAS_UTILIZADAS_MES_5" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_5") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else if (campo === "QTD_ALUNOS_MES_6" || campo === "HORAS_UTILIZADAS_MES_6" || campo === "RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_6") {
                    cell.innerHTML = `<input class="form-control form-control-sm" type="number" id="${campo}_${registros.length - 1}" name="${campo}_${registros.length - 1}" required>`;
                }
                else {
                    cell.textContent = registros[registros.length - 1][campo] || "";
                }
            });


        }

        function enviarParaPlanilha() {

            if (validarFormulario()) {
                const url = "https://script.google.com/macros/s/AKfycbyGD37Nb0eip7r22XgSs8xMpIsaAJy4fibbUWDK-wiHJ6j3C8uuPZmHVaXBbwEpMH38/exec";
                const promises = registros.map((registro, index) => {
                    const formData = new URLSearchParams();
                    formData.append("FILIAL", registro.FILIAL);
                    formData.append("CNPJ", registro.CNPJ);
                    formData.append("CONVENIO", registro.CONVENIO);
                    formData.append("RODIZIO", registro.RODIZIO);
                    formData.append("QTD_ALUNOS_MES_1", document.getElementById(`QTD_ALUNOS_MES_1_${index}`).value);
                    formData.append("HORAS_UTILIZADAS_MES_1", document.getElementById(`HORAS_UTILIZADAS_MES_1_${index}`).value);
                    formData.append("RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_1", document.getElementById(`RELACAO_ALUNO_PRECEPTOR_GRUPO_MES_1_${index}`).value);

                    return fetch(url, {
                        method: "POST",
                        body: formData
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error("Erro ao enviar dados.");
                        }
                    });
                });

                Promise.all(promises)
                    .then(() => {
                        alert("Todos os dados foram enviados para a planilha com sucesso!");
                        document.getElementById("enviarDadosPlanilha").disabled = true;
                        document.getElementById("adicionarTabela_").disabled = true;
                        document.querySelectorAll('input').forEach(input => input.disabled = true);
                        document.querySelectorAll('select').forEach(select => select.disabled = true);
                        window.scrollTo(0, 0);

                    })
                    .catch(error => {
                        console.error("Erro:", error);
                        alert("Erro ao enviar alguns dados. Verifique e tente novamente.");
                    });
            }
        }

        function validarFormulario() {
            // Seleciona todos os inputs e selects do formulário
            const inputs = document.querySelectorAll('input');
            const selects = document.querySelectorAll('select');
            let todosPreenchidos = true;

            // Verifica se todos os inputs estão preenchidos
            inputs.forEach(input => {
                if (input.value.trim() === '') {
                    todosPreenchidos = false;
                }
            });

            // Verifica se todos os selects estão preenchidos (se não tiver valor selecionado)
            selects.forEach(select => {
                if (select.value === '' || select.selectedIndex === 0) {
                    todosPreenchidos = false;
                }
            });

            // Exibe alerta se algum campo estiver vazio
            if (!todosPreenchidos) {
                alert('Por favor, preencha todos os campos.');
                return false; // Impede o envio do formulário
            }

            return true; // Permite o envio do formulário se tudo estiver preenchido
        }

    </script>

    <!-- JavaScript (Opcional) -->
    <!-- jQuery primeiro, depois Popper.js, depois Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

</body>

</html>